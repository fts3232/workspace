<include file="Common:header"/>
<div class="table-responsive inject item-body menu">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">属性</h3>
        </div>
        <div class="panel-body">
            <form class="form-horizontal">
                <div class="form-group">
                    <label for="inputName" class="col-sm-4 control-label">栏目</label>
                    <div class="col-sm-8">
                        <select class="category form-control" name="category">

                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="inputName" class="col-sm-4 control-label">发布时间</label>
                    <div class="col-sm-8">
                        <span>立即发布</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="inputUrl" class="col-sm-4 control-label">标签</label>
                    <div class="col-sm-8">
                        <input type="text" class="form-control" style="
    display: inline-block;width: 62%;margin-right: 10px;" id="inputUrl" name="url"/>
                        <button type="submit" class="btn btn-default right add">添加</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">文章</h3>
        </div>
        <div class="panel-body">
            <form class="form-line">
                <div class="form-group">
                    <label for="inputName" class="col-sm-2 control-label">标题</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" id="inputName" name="title" value="{$result['TITLE']|default=''}"/>
                    </div>
                </div>
                <div class="form-group">
                    <label for="inputUrl" class="col-sm-2 control-label">关键词</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" id="inputUrl" name="keyword" value="{$result['KEYWORD']|default=''}"/>
                    </div>
                </div>
                <div class="form-group">
                    <label for="inputUrl" class="col-sm-2 control-label">描述</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" id="inputUrl" name="description" value="{$result['DESCRIPTION']|default=''}"/>
                    </div>
                </div>
                <div class="form-group">
                    <label for="inputUrl" class="col-sm-2 control-label">正文</label>
                    <div class="col-sm-10">
                        <textarea name="content">{$result['CONTENT']|default=''}</textarea>
                    </div>
                </div>
            </form>
        </div>
        <div class="panel-footer">
            <a href="{:U('index')}">
                <button type="submit" class="btn btn-default right">返回</button>
            </a>
            <button type="submit" class="btn btn-primary right save-menu" data-loading-text="Loading..."
                    style="margin-right: 10px">保存
            </button>
        </div>
    </div>
</div>
<div class="alert alert-dismissible fade out" role="alert">
    <button type="button" class="close"><span aria-hidden="true">×</span></button>
    <p></p>
</div>
<script src="https://cdn.bootcss.com/tinymce/4.7.13/tinymce.min.js"></script>
<script>
    function create_category_item(item,select, depth) {
        var before = ''
        for (i = 0; i < depth; i++) {
            before += '|－';
        }
        var li = $('<option value="' + item.CATEGORY_ID + '">' + before + item.CATEGORY_NAME + '</option>')
        if(select == item.CATEGORY_ID){
            li.attr('selected',true);
        }
        return li
    }

    function create_category(category,select, depth) {
        var depth = depth == undefined ? 0 : depth;
        category.map(function (v, k) {
            var item = create_category_item(v,select, depth)
            item.appendTo($('select.category'))
            if (v.CHILD != '') {
                create_category(v.CHILD,select, depth + 1)
            }
        })
    }

    $(function () {
        create_category({$category},'{$result["CATEGORY_ID"]|default=""}')
        tinymce.init({
            selector: 'textarea',
            height: 500,
            theme: 'modern',
            images_upload_url: 'postAcceptor.php',
            plugins: 'print preview fullpage searchreplace autolink directionality visualblocks visualchars fullscreen image link media template codesample table charmap hr pagebreak nonbreaking anchor toc insertdatetime advlist lists textcolor wordcount imagetools contextmenu colorpicker textpattern help',
            toolbar1: 'formatselect | bold italic strikethrough forecolor backcolor | link | alignleft aligncenter alignright alignjustify  | numlist bullist outdent indent  | removeformat',
            image_advtab: true,
        });
        //添加菜单项
        $('button.add').on('click', function () {
            var index = $('.sortable li').length + 1;
            var name = $.trim($('input[name="name"]').val());
            if (name == '') {
                alertMessage('warning', '请输入菜单项名称！')
                return false;
            }
            var url = $.trim($('input[name="url"]').val());
            if (url == '') {
                alertMessage('warning', '请输入菜单项url！')
                return false;
            }
            var data = {
                'ITEM_ID': 0,
                'ITEM_NAME': name,
                'ITEM_PARENT': 0,
                'ITEM_URL': url,
                'ITEM_ORDER': 0,
            };
            var item = create_item(index, data, 0)
            item.appendTo('.sortable')
            var root = $('.sortable');
            var list = root.find('li');
            //排序
            reset_order();
            return false;
        })
        //删除菜单项
        $(document).on('click', 'button.delete', function () {
            $(this).parents('li').remove();
            reset_order()
            return false;
        })
        //保存
        $('button.save-menu').on('click', function () {
            var $btn = $(this).button('loading')
            $.ajax({
                'url': "{:U('add')}",
                'type': 'post',
                'data': {
                    'category': $('[name="category"]').val(),
                    'title': $('[name="title"]').val(),
                    'keyword': $('[name="keyword"]').val(),
                    'description': $('[name="description"]').val(),
                    'content': tinyMCE.activeEditor.getContent(),
                },
                'success': function (data) {
                    if (data.status) {
                        alertMessage('success', data.msg)
                    } else {
                        alertMessage('danger', data.msg, data.code)
                    }
                },
                'complete': function () {
                    $btn.button('reset')
                }
            })
        })
    });
</script>
<include file="Common:footer"/>