<include file="Common:header" />
<div class="table-responsive inject item-body category">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">添加栏目</h3>
        </div>
        <div class="panel-body">
            <form class="form-horizontal">
                <div class="form-group">
                    <label for="inputName" class="col-sm-3 control-label">名称</label>
                    <div class="col-sm-9">
                        <input type="text"  class="form-control" id="inputName" name="name"/>
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-sm-offset-2 col-sm-10">
                        <button type="submit" class="btn btn-default right add">添加</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">栏目</h3>
        </div>
        <div class="panel-body">
            <ul class="sortable">

            </ul>
        </div>
        <div class="panel-footer">
            <button type="submit" class="btn btn-primary right save-menu" data-loading-text="Loading..." style="margin-right: 10px">保存</button>
        </div>
    </div>
</div>
<div class="alert alert-dismissible fade out" role="alert">
    <button type="button" class="close"><span aria-hidden="true">×</span></button>
    <p></p>
</div>
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="deleteModalLabel">删除</h4>
            </div>
            <div class="modal-body">
                是否确认删除该栏目？
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger delete-confirm" data-loading-text="Loading...">删除</button>
                <button type="button" class="btn btn-default" data-dismiss="modal" aria-label="Close">取消</button>
            </div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script>
    function create_item(index, data,depth) {
        var li = $('<li data-index="' + index + '" data-id="' + data.CATEGORY_ID + '" data-parent="' + data.CATEGORY_PARENT + '" data-depth="' + depth + '" data-order="' + data.CATEGORY_ORDER + '" class="ui-sortable-handle"></li>')
        li.css('marginLeft', depth * 30 + 'px')

        var div = $('<div class="ui-state-default"></div>');
        var itemName = $('<span>' + data.CATEGORY_NAME + '</span>')

        var collapseID = 'item-index-' + index;

        var collapseButton = $('<a role="button" data-toggle="collapse" href="#' + collapseID + '" aria-expanded="false" aria-controls="' + collapseID + '"> <span class="glyphicon glyphicon-menu-down right" aria-hidden="true"></span> </a>');

        itemName.appendTo(div);
        collapseButton.appendTo(div);


        var collapse = $('<div class="collapse" id="' + collapseID + '"></div>')
        var well = $('<div class="well"></div>')

        var form = $('<form class="form-horizontal"></form>')
        var nameGroup = $('<div class="form-group"></div>')
        var nameLabel = $('<label for="input-name-edit-' + index + '" class="col-sm-3 control-label">名称</label>')
        var nameInputWrapper = $('<div class="col-sm-9"></div>')
        $('<input type="text"  class="form-control" id="input-name-edit-' + index + '" name="name" value="' + data.CATEGORY_NAME + '"/>').appendTo(nameInputWrapper);
        nameLabel.appendTo(nameGroup);
        nameInputWrapper.appendTo(nameGroup);

        var button = $('<div class="form-group"></div>');
        var buttonWrapper = $('<div class="col-sm-offset-2 col-sm-10"></div>');
        $('<button type="submit" class="btn btn-danger right delete">删除</button>').appendTo(buttonWrapper);
        buttonWrapper.appendTo(button);

        nameGroup.appendTo(form);
        button.appendTo(form);

        form.appendTo(well);
        well.appendTo(collapse);

        div.appendTo(li);
        collapse.appendTo(li);

        var clone = $('<ul></ul>');
        clone.appendTo(li);

        return li
    }

    var i = 0;
    function create_category(category,depth) {
        var depth = depth == undefined ? 0 : depth;
        category.map(function (v, k) {
            var item = create_item(i, v,depth)
            i++;
            item.appendTo($('.sortable'))
            if (v.CHILD != '') {
                create_category(v.CHILD, depth + 1)
            }
        })
    }

    function clone_item(item, child) {
        var height = item.height();
        child.map(function (i) {
            item.find('ul').eq(0).append(child.eq(i).clone())
            var childID = child.eq(i).attr('data-id')
            height += child.eq(i).height()
            child.eq(i).remove()

            var temp = item.parent('ul').find('[data-parent="' + childID + '"]');
            clone_item(item, temp)
        })

        $('.ui-state-highlight').css('height', height + 'px')
    }

    function calculate_depth(item, direction) {
        var parentLeft = parseInt(item.prev('.ui-sortable-handle').css('marginLeft'));
        if (isNaN(parentLeft)) {
            parentLeft = parseInt(item.parents('li').css('marginLeft'));
        }
        var ownLeft = parseInt(item.css('marginLeft'));
        var maxLeft = parentLeft + 30;
        if (direction == 'right') {
            var offset = ownLeft + 30 > maxLeft ? maxLeft : ownLeft + 30;
        } else {
            var offset = ownLeft - 30 < 0 ? 0 : ownLeft - 30;
        }
        var depth = offset / 30;
        item.attr('data-depth', depth)
        item.css('margin-left', offset + 'px')
        if (offset != ownLeft) {
            var child = item.find('ul').eq(0).find('li')
            child.map(function (i) {
                calculate_depth(child.eq(i), direction)
            })
        }
    }

    function reset_order() {
        var root = $('.sortable')
        var list = root.find('li');
        //排序
        var checkParent = [];
        list.map(function (i, v) {
            var parent = list.eq(i).attr('data-parent')
            if (checkParent.indexOf(parent) == -1) {
                var siblings = root.find('[data-parent="' + parent + '"]')
                siblings.map(function (i, v) {
                    siblings.eq(i).attr('data-order', i)
                })
                checkParent.push[parent];
            }
        })
    }

    $(function () {
        var category = {$items};
        if(category != null){
            create_category(category)
        }

        var sort = $(".sortable").sortable({
            revert     : true,
            containment: "document",
            placeholder: "ui-state-highlight",
            start      : function (event, ui) {
                var ownLeft = parseInt($(ui.item).css('marginLeft'));
                var id = $(ui.item).attr('data-id')
                $('.ui-state-highlight').css('marginLeft', ownLeft);

                if (id != 0) {
                    var child = $(ui.item).parent('ul').find('[data-parent="' + id + '"]');
                    clone_item($(ui.item), child)
                }
                $(".sortable").sortable("refreshPositions");
            },
            sort       : function (event, ui) {
                if ($(ui.item).prev('.ui-sortable-handle').length > 0 || $(ui.item).parents('.child').length > 0) {
                    var parentLeft = parseInt($(ui.item).prev('.ui-sortable-handle').css('marginLeft'));
                    var ownLeft = parseInt($(ui.item).css('marginLeft'));
                    var maxLeft = parentLeft + 30;
                    if (ui.position.left - ui.originalPosition.left > 30) {
                        var offset = ownLeft + 30 > maxLeft ? maxLeft : ownLeft + 30;
                        $('.ui-state-highlight').css('margin-left', offset + 'px')
                    } else if (ui.originalPosition.left - ui.position.left > 30) {
                        var offset = ownLeft - 30 < 0 ? 0 : ownLeft - 30;
                        $('.ui-state-highlight').css('margin-left', offset + 'px')
                    }
                }
            },
            stop       : function (event, ui) {
                var root = $(ui.item).parent('ul')
                var list = root.find('li');
                //parent
                list.map(function (i, v) {
                    var depth = list.eq(i).attr('data-depth')
                    if (depth == 0) {
                        list.eq(i).attr('data-parent', 0)
                    } else {
                        depth = depth - 1
                        var parent = list.eq(i).prevAll('[data-depth="' + depth + '"]').attr('data-id')
                        list.eq(i).attr('data-parent', parent)
                    }
                })
                //排序
                reset_order()

                //释放child
                list = $(ui.item).find('ul li')
                var after = $(ui.item)
                list.map(function (i) {
                    after.after(list.eq(i));
                    after = list.eq(i)
                })
            },
            beforeStop : function (event, ui) {
                if ($(ui.item).prev('.ui-sortable-handle').length > 0 || $(ui.item).parents('.child').length > 0) {
                    var parentLeft = parseInt($(ui.item).prev('.ui-sortable-handle').css('marginLeft'));
                    var ownLeft = parseInt($(ui.item).css('marginLeft'));
                    var maxLeft = parentLeft + 30;
                    var child = $(ui.item).find('ul').eq(0).find('li')
                    if (ui.position.left - ui.originalPosition.left > 30) {
                        calculate_depth($(ui.item), 'right')
                    } else if (ui.originalPosition.left - ui.position.left > 30) {
                        calculate_depth($(ui.item), 'left')
                    }
                }
            }
        });


        //添加栏目
        $('button.add').on('click', function () {
            var index = $('.sortable li').length + 1;
            var name = $.trim($('input[name="name"]').val());
            if (name == '') {
                alertMessage('warning', '请输入名称！')
                return false;
            }
            var data = {
                'CATEGORY_ID'    : 0,
                'CATEGORY_NAME'  : name,
                'CATEGORY_PARENT': 0,
                'CATEGORY_ORDER' : 0,
            };
            var item = create_item(index, data, 0)
            item.appendTo('.sortable')
            //排序
            reset_order();
            return false;
        })
        //删除栏目
        $(document).on('click','button.delete', function () {
            var id= $(this).parents('li').attr('data-id');
            var index = $(this).parents('li').index();
            $('#deleteModal .delete-confirm').attr('data-index',index);
            $('#deleteModal .delete-confirm').attr('data-id',id);
            $('#deleteModal').modal('show')
            return false;
        })

        $('button.delete-confirm').on('click', function () {
            var $btn = $(this).button('loading')
            var index = $(this).attr('data-index');
            var id = $(this).attr('data-id');
            $.ajax({
                'url'     : '{:U("delete")}',
                'type'    : 'post',
                'data'    : {
                    'id': id
                },
                'success' : function (data) {
                    if (data.status) {
                        alertMessage('success', data.msg)
                        $('#deleteModal').modal('hide')
                        $('.sortable li').eq(index).remove();
                    } else {
                        alertMessage('danger', data.msg, data.code)
                    }
                },
                'complete': function () {
                    $btn.button('reset')
                }
            })
        })

        //保存
        $('button.save-menu').on('click',function(){
            var $btn = $(this).button('loading')
            var items = [];
            var addItems = [];
            $('.sortable li').map(function(v){
                var arr = {
                    'CATEGORY_ID'   : $('.sortable li').eq(v).attr('data-id'),
                    'CATEGORY_NAME'  : $('.sortable li').eq(v).find('[name="name"]').val(),
                    'CATEGORY_PARENT'  : $('.sortable li').eq(v).attr('data-parent'),
                    'CATEGORY_ORDER': $('.sortable li').eq(v).attr('data-order'),
                }
                if (arr['CATEGORY_ID'] == 0) {
                    addItems.push(arr)
                } else {
                    items.push(arr)
                }
            })
            $.ajax({
                'url':"{:U('update')}",
                'type':'post',
                'data':{
                    'items':items,
                    'addItems':addItems
                },
                'success':function(data){
                    if (data.status) {
                        alertMessage('success', data.msg)
                    } else {
                        alertMessage('danger', data.msg, data.code)
                    }
                },
                'complete':function(){
                    $btn.button('reset')
                }
            })
        })
    });
</script>
<include file="Common:footer" />